window.GFStripeAdmin=null,function(o){function e(){var r=this;this.accountSettingsLocked=!1,this.deauthActionable=!1,this.inputContainerPrefix=gforms_stripe_admin_strings.input_container_prefix,this.inputPrefix=gforms_stripe_admin_strings.input_prefix,this.liveDependencySupported=gforms_stripe_admin_strings.liveDependencySupported,this.apiMode=gforms_stripe_admin_strings.apiMode,this.init=function(){this.initKeyStatus("live_publishable_key"),this.initKeyStatus("live_secret_key"),this.initKeyStatus("test_publishable_key"),this.initKeyStatus("test_secret_key"),this.bindDeauthorize(),this.liveDependencySupported||this.bindAPIModeChange(),this.maybeLockAccountSettings(),this.bindWebhookAlert(),this.bindRefund(),this.bindCapture()},this.validateKey=function(e,t){0!=t.length?(o("#"+e).val(t.trim()),this.setKeyStatusIcon(e,"<img src='"+gforms_stripe_admin_strings.spinner+"'/>"),"live_publishable_key"==e||"test_publishable_key"==e?this.validatePublishableKey(e,t):this.validateSecretKey(e,t)):this.setKeyStatus(e,"")},this.validateSecretKey=function(t,e){o.post(ajaxurl,{action:"gf_validate_secret_key",keyName:t,key:e,nonce:gforms_stripe_admin_strings.ajax_nonce},function(e){"valid"==(e=e.trim())?r.setKeyStatus(t,"1"):"invalid"==e?r.setKeyStatus(t,"0"):r.setKeyStatusIcon(t,gforms_stripe_admin_strings.validation_error)})},this.validatePublishableKey=function(i,e){this.setKeyStatusIcon(i,"<img src='"+gforms_stripe_admin_strings.spinner+"'/>"),cc={number:"4916433572511762",exp_month:"01",exp_year:(new Date).getFullYear()+1,cvc:"111",name:"Test Card"},Stripe.setPublishableKey(e),Stripe.card.createToken(cc,function(e,t){200!=e&&(400!=e&&402!=e||"live_publishable_key"!=i)?r.setKeyStatus(i,"0"):r.setKeyStatus(i,"1")})},this.initKeyStatus=function(e){var t=o("#"+e+"_is_valid"),i=o("#"+e);0<t.length?this.setKeyStatus(e,t.val()):0<i.length&&this.validateKey(e,i.val())},this.setKeyStatus=function(e,t){o("#"+e+"_is_valid").val(t);var i="";"1"==t?i='<i class="fa icon-check fa-check gf_valid"></i>':"0"==t&&(i='<i class="fa icon-remove fa-times gf_invalid"></i>'),this.setKeyStatusIcon(e,i)},this.setKeyStatusIcon=function(e,t){var i=o("#"+e+"_status_icon");0<i.length&&i.remove(),o("#"+e).after("<span id='"+e+"_status_icon'>&nbsp;&nbsp;"+t+"</span>")},this.bindDeauthorize=function(){o(".gform_stripe_deauth_button").on("click",function(e){if(e.preventDefault(),r.accountSettingsLocked)return window.location.reload(),!1;var t=o("#gform_stripe_deauth_button"),i=o("#deauth_scope"),n=gforms_stripe_admin_strings.disconnect,s=o(this).data("mode"),a=o(this).data("fid");if(r.deauthActionable){e=o("#"+s+"_deauth_scope0").is(":checked")?"site":"account",n="site"==e&&""!==a?n.feed:n[e];if(!confirm(n))return!1;t.attr("disabled","disabled"),o.ajax({async:!1,url:ajaxurl,dataType:"json",method:"POST",data:{action:"gfstripe_deauthorize",scope:e,fid:a,id:o(this).data("id"),mode:s,nonce:gforms_stripe_admin_strings.ajax_nonce},success:function(e){e.success?window.location.reload():alert(e.data.message),t.removeAttr("disabled")}})}else o(".gform_stripe_deauth_button").eq(0).hide(),""!==a&&o(".connected_to_stripe_text").hide(),i.show(0,function(){r.deauthActionable=!0})})},this.bindAPIModeChange=function(){""!==this.apiMode&&void 0!==this.apiMode||(this.apiMode="live",o("#api_mode0").prop("checked",!0));var t="live"===this.apiMode?"test":"live";o("#"+this.inputContainerPrefix+this.apiMode+"_auth_token").show(),o("#"+this.inputContainerPrefix+t+"_auth_token").hide(),o('#tab_gravityformsstripe input[name="'+this.inputPrefix+'_api_mode"]').on("click",function(e){r.apiMode=o(this).val(),t="live"===r.apiMode?"test":"live",o("#"+r.inputContainerPrefix+t+"_auth_token").hide(),o("#"+r.inputContainerPrefix+r.apiMode+"_auth_token").show()})},this.maybeLockAccountSettings=function(){o("#"+this.inputContainerPrefix+"connected_to").siblings("#"+this.inputContainerPrefix+"api_mode, #"+this.inputContainerPrefix+"live_auth_token, #"+this.inputContainerPrefix+"test_auth_token").hide(),o("#gform_stripe_change_account").on("click",function(){var e;o(this).data("disabled")?alert(gforms_stripe_admin_strings.switch_account_disabled_message):(o("#"+r.inputContainerPrefix+"api_mode").show(),e="live"===r.apiMode?"test":"live",o("#"+r.inputContainerPrefix+e+"_auth_token").hide(),o("#"+r.inputContainerPrefix+r.apiMode+"_auth_token").show(),o(this).off("click").addClass("disabled"))}),o("table.gforms_form_settings").on("change","input, select",function(){var e=o(this).attr("name");e!==r.inputPrefix+"_api_mode"&&"deauth_scope"!==e&&e!==r.inputPrefix+"_transactionType"&&(r.accountSettingsLocked=!0)}),o("#gform-settings-save").on("click",function(){o(".error.below-h2").remove(),r.accountSettingsLocked=!1}),window.addEventListener("beforeunload",function(e){r.accountSettingsLocked&&(e.preventDefault(),e.returnValue="")})},this.bindWebhookAlert=function(){o("#gform_stripe_change_account").length&&""===o("#"+this.apiMode+"_signing_secret").val()&&(o("#webhooks_enabled").focus(),o([document.documentElement,document.body]).animate({scrollTop:o("#"+r.inputContainerPrefix+"api_mode").offset().top+20},1e3))},this.bindRefund=function(){o(".stripe-refund").on("click",function(e){e.preventDefault();var n=o(".stripe_refund"),s=o("#refund_wait_container"),e=o(this).data("tid");if(entryId=o(this).data("lid"),!window.confirm(gforms_stripe_admin_strings.refund))return!1;n.prop("disabled",!0),s.fadeIn(),wp.a11y.speak(gforms_stripe_admin_strings.refund_processing,"assertive"),o.ajax({async:!0,url:ajaxurl,dataType:"json",method:"POST",data:{action:"gfstripe_refund",transaction_id:e,entry_id:entryId,nonce:gforms_stripe_admin_strings.refund_nonce},success:function(e){e.success?window.location.reload():(wp.a11y.speak(e.data.message,"assertive"),o(".gform_stripe_refund_alert").show().html(e.data.message))},complete:function(){wp.a11y.speak(gforms_stripe_admin_strings.refund_complete,"assertive"),n.prop("disabled",!1),s.hide()}}).fail(function(e,t,i){window.alert(i),n.prop("disabled",!1),s.hide()})})},this.bindCapture=function(){o(".stripe-capture").on("click keypress",function(e){e.preventDefault();var n=o(".stripe-capture"),s=o("#capture_wait_container");if(errorContainer=o(".gform_stripe_capture_alert"),!window.confirm(gforms_stripe_admin_strings.capture_confirm))return!1;s.fadeIn(),n.prop("disabled",!0),errorContainer.hide(),wp.a11y.speak(gforms_stripe_admin_strings.capture_processing,"assertive");e=n.data("ajax");o.ajax({url:ajaxurl,method:"POST",data:{action:"gfstripe_capture_action",transaction_id:e.transaction_id,entry_id:e.entry_id,nonce:e.nonce},success:function(e){e.success?(wp.a11y.speak(gforms_stripe_admin_strings.capture_complete,"assertive"),window.location.reload()):(wp.a11y.speak(e.data,"assertive"),errorContainer.show().html(e.data),n.prop("disabled",!1),s.hide())}}).fail(function(e,t,i){wp.a11y.speak(i,"assertive"),errorContainer.show().html(i),n.prop("disabled",!1),s.hide()})})},this.init()}o(document).ready(function(){GFStripeAdmin=new e})}(jQuery);