jQuery(document).ready(function(e){"use strict";e.widget("cp.wpcp_reports",{options:{$container_totals:e("#wpcp-counter-totals"),$container_events_chart:e("#wpcp-events-chart"),$container_top_downloads:e("#top-downloads"),$container_top_users:e("#top-users"),$container_latest_uploads:e("#latest-uploads"),$container_top_uploads:e("#top-uploads"),$container_full_log:e("#full-log")},chartjs:null,_create:function(){this._initiate()},_destroy:function(){return this._super()},_setOption:function(e,t){this._super(e,t)},_initiate:function(){var e=this;this._initChartDatePicker(),this._initChart(),this.options.$container_totals.one("inview",function(t,a){e.loadTotalsData(e.options.$container_totals,null,null)}),this.options.$container_events_chart.one("inview",function(t,a){e.loadChartData()}),this.options.$container_top_downloads.one("inview",function(t,a){e.loadTopDownloads()}),this.options.$container_top_users.one("inview",function(t,a){e.loadTopUsers()}),this.options.$container_latest_uploads.one("inview",function(t,a){e.loadLatestUploads()}),this.options.$container_top_uploads.one("inview",function(t,a){e.loadTopUploads()}),this.options.$container_full_log.one("inview",function(t,a){e.loadFullLog()}),this._initEvents()},_initEvents:function(){var t=this;e(t.element).on("click","a.open-entry-details",function(a){var n=e(this).data("entry-id"),s=e(this).data("account-id");t.viewEntryDetails(n,s)}),e(t.element).on("click","a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e(t.element).on("click","#clear_statistics",function(e){t.clearStatistics()})},clearStatistics:function(){var t=this,a=e("#clear_statistics");a.prop("disabled",!0).addClass("disabled"),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"shareonedrive-reset-statistics",_ajax_nonce:t.options.admin_nonce},complete:function(){a.prop("disabled",!1).removeClass("disabled"),location.reload()},dataType:"json"})},_initChartDatePicker:function(){var e=this,t=e.element.find(".date_range_selector");e.date_range_selector=t.flatpickr({defaultDate:["today",moment().subtract(1,"months").toDate()],dateFormat:"d-m-Y",mode:"range",showMonths:2,onValueUpdate:function(t,a,n){clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadTotalsData(e.options.$container_totals,null,null),e.loadChartData(),e.topDownloads.ajax.reload(),e.topUsers.ajax.reload(),e.topUploads.ajax.reload(),e.latestUploads.ajax.reload(),e.fullLog.ajax.reload()},1e3)}})},loadChartData:function(){var t=this;t.options.$container_events_chart.prev().fadeIn(),t.chartjs.reset(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"activities",periodstart:moment(t.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(t.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e){t.chartjs.data=e,t.chartjs.update()},complete:function(e){t.options.$container_events_chart.prev().fadeOut()},dataType:"json"})},_initChart:function(){var e=this;e.chartjs=new Chart(e.options.$container_events_chart,{type:"line",options:{fill:!0,tension:.3,responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{mode:"index",position:"nearest"}},scales:{x:{type:"time",beginAtZero:!1,time:{parser:"DD-MM-YYYY",unit:"day",tooltipFormat:"LL"},title:{display:!1}},y:{beginAtZero:!1,title:{display:!1}}}}})},loadTotalsData:function(t,a,n){var s=this;t.find(".wpcp-counter span").css({"background-color":"",color:""}),e.ajax({method:"POST",url:s.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"totals",detail:a,id:n,periodstart:moment(s.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(s.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:s.options.admin_nonce},success:function(e){s._setTotalsData(t,e)},complete:function(e){t.find(".loading").fadeOut()},dataType:"json"})},_setTotalsData:function(t,a){e.each(t.find(".wpcp-counter"),function(){var t=e(this).data("type");if(e(this).html('<div class="loading" style="display: none;"><div class="wpcp-loading-beat"></div></div>'),void 0===a[t])return e(this).append("0"),!0;var n=parseInt(a[t].total);e(this).css({"background-color":a[t].colors.normal,color:"white"}).append(n)})},loadTopDownloads:function(){var e=this;e.topDownloads=e.options.$container_top_downloads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",scrollCollapse:!0,paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all dt-left",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'" data-account-id="'+a.account_id+'">'+a.entry_name+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"topdownloads",length:25,periodstart:moment(e.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(e.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce}}})},loadTopUsers:function(){var e=this;e.topUsers=e.options.$container_top_users.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",scrollCollapse:!0,paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all dt-left",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"topusers",length:25,periodstart:moment(e.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(e.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce}}})},loadLatestUploads:function(){var e=this;e.latestUploads=e.options.$container_latest_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",scrollCollapse:!0,paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"datetime"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all dt-left",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'" data-account-id="'+a.account_id+'">'+a.entry_name+"</a>"}},{name:"datetime",targets:2,width:"120px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"latestuploads",length:25,periodstart:moment(e.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(e.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce}}})},loadTopUploads:function(){var e=this;e.topUploads=e.options.$container_top_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",scrollCollapse:!0,paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all dt-left",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"topuploads",length:25,periodstart:moment(e.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(e.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce}}})},loadFullLog:function(){var t=this;t.fullLog=t.options.$container_full_log.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:500,scroller:!0,scrollCollapse:!0,pageLength:50,searchDelay:600,buttons:[{text:'<i class="eva eva-download-outline eva-lg"></i>',className:"wpcp-button-primary",action:function(a,n,s,o){e.ajax({url:t.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"full-log",export:!0,periodstart:moment(t.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),periodend:moment(t.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.setAttribute("download","data.csv"),o.click()}})}},{extend:"copy",text:'<i class="eva eva-copy-outline eva-lg"></i>',className:"wpcp-button-primary"},{extend:"print",text:'<i class="eva eva-printer-outline eva-lg"></i>',className:"wpcp-button-primary",title:""},{extend:"colvis",text:'<i class="eva eva-funnel-outline eva-lg"></i>',className:"wpcp-button-primary",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='eva "+e+" eva-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="eva eva-external-link-outline"></i> '+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:t.options.ajax_url,data:function(e){e.action="shareonedrive-event-stats",e.type="full-log",e.periodstart=moment(t.date_range_selector.selectedDates[0]).format("YYYY-MM-DD"),e.periodend=moment(t.date_range_selector.selectedDates[1]).format("YYYY-MM-DD"),e._ajax_nonce=t.options.admin_nonce}}})},loadDetailedLog:function(t,a,n){var s=this;t.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:300,scroller:!0,pageLength:50,searchDelay:600,responsive:!0,buttons:[{text:'<i class="eva eva-download-outline eva-lg"></i>',className:"wpcp-button-primary",action:function(t,o,r,i){e.ajax({url:s.options.ajax_url,data:{action:"shareonedrive-event-stats",type:"full-log",detail:a,id:n,export:!0,_ajax_nonce:s.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.setAttribute("download","data.csv"),o.click()}})}},{extend:"copy",text:'<i class="eva eva-copy-outline eva-lg"></i>',className:"wpcp-button-primary"},{extend:"print",text:'<i class="eva eva-printer-outline eva-lg"></i>',className:"wpcp-button-primary",title:""},{extend:"colvis",text:'<i class="eva eva-funnel-outline eva-lg"></i>',className:"wpcp-button-primary",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='eva "+e+" eva-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="eva eva-external-link-outline"></i>'+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:s.options.ajax_url+"?action=shareonedrive-event-stats&type=full-log&detail="+a+"&id="+n+"&_ajax_nonce="+s.options.admin_nonce})},viewEntryDetails:function(e,t){var a=this;a.openModal("entry",e,t)},viewUserDetails:function(e){var t=this;t.openModal("user",e,null)},openModal:function(t,a,n){var s=this,o=t+"-"+a,r=e("#wpcp-modal-details-template").clone();r.attr("id",o).appendTo("#wpcp");var i=r.find("#wpcp-event-details-totals");s.loadTotalsData(i,t,a),e.ajax({type:"POST",url:s.options.ajax_url,data:{action:"shareonedrive-event-stats",account_id:n,type:"get-detail",detail:t,id:a,_ajax_nonce:s.options.admin_nonce},success:function(e){switch(t){case"user":r.find(".wpcp-event-details-name").text(e.user.user_name),r.find(".wpcp-event-details-description").text(e.user.user_email),r.find(".wpcp-event-details-entry-img").attr("src",e.user.avatar),r.find(".wpcp-event-download-entry").fadeOut();break;case"entry":r.find(".wpcp-event-details-name").text(e.entry.entry_name),r.find(".wpcp-event-details-description").html(e.entry.entry_description),r.find(".wpcp-event-details-entry-img").attr("src",e.entry.entry_thumbnails),!1===e.entry.entry_link?r.find(".wpcp-event-download-entry").fadeOut():r.find(".wpcp-event-download-entry").attr("href",e.entry.entry_link+"&_ajax_nonce="+s.options.admin_nonce)}},complete:function(){r.find(".wpcp-event-details-loader").fadeOut().prev().removeClass("opacity-0")},dataType:"json"}),r.fadeIn(),s.loadDetailedLog(r.find("#wpcp-full-detail-log"),t,a)}}),e(".wpcp-reports").wpcp_reports(ShareoneDrive_Report_Vars)});