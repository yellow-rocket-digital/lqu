(function(e){"use strict";function t(e){e.origin===window.parent.location.origin&&"object"==typeof e.data&&null!==e.data&&void 0!==e.data.action&&"wpcp-change-value"===e.data.action&&a(e.data.id,e.data.value,e.data.oldvalue)}function a(t,a,o){window.hideNotifications(),i(),e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-save-setting",key:t,value:a,network:s.is_network,_ajax_nonce:s.admin_nonce},success:function(a){e.each(a,function(e,a){t!==e&&n(e,a),"reload"===e&&!0===a&&window.location.reload()}),window.showNotification(!0)},error:function(){n(t,o),window.showNotification(!1)},dataType:"json"}),e.ajaxQueue.run()}function n(t,a){var n=e("#"+t);"text"===n.attr("type")||n.is("textarea")?n.val(a):"checkbox"===n.attr("type")?n.prop("checked","Yes"===a).trigger("change"):n.is("select")?n.val(a):"text"===n.attr("type")&&n.val(a).trigger("change")}function o(t,a){var n=e('.wpcp-license[data-license-code="'+t+'"]');e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-license",license_code:t,type:a,_ajax_nonce:s.admin_nonce},success:function(t){"deactivate"===a&&window.location.reload(),!1===t.valid?(e(".purchase-input-error-message").text("Invalid License. Check the code again or activate via Envato Market."),e("#wpcp-modal-activation").fadeIn(),e(".purchase-input-error").fadeIn()):"activate"===a?window.location.reload():(n.find(".wpcp-license-icon").attr("src",t.data.item.previews.icon_preview.icon_url),n.find(".wpcp-license-buyer").text(t.data.buyer),n.find(".wpcp-license-buyer").attr("href","http://themeforest.net/user/"+t.data.buyer),n.find(".wpcp-license-type").text(t.data.license),n.find(".wpcp-license-support").text(t.supported_until_str),!1===t.support_package&&n.find(".wpcp-license-error").slideDown().find(".wpcp-license-error-message").text(t.error_message),n.find(".wpcp-license-details").slideDown())},error:function(t){e(".purchase-input-error-message").text("Invalid License. Check the code again or activate via Envato Market."),e("#wpcp-modal-activation").fadeIn(),e(".purchase-input-error").fadeIn(),e(this).parents(".wpcp-license").slideDown()},dataType:"json"})}function i(){for(var e=sessionStorage.length;e--;){var t=sessionStorage.key(e);/wpcp/.test(t)&&sessionStorage.removeItem(t)}}var c,r,s=ShareoneDrive_Admin_vars;e(".wpcp-color-picker").wpColorPicker({change:function(t,a){c&&clearTimeout(c),c=setTimeout(function(t){e(t).trigger("change")},500,t.target)}}),e(".wpcp-image-selector-button").on("click",function(t){var a=e(this).parent().parent().find("input");r=wp.media.frames.file_frame=wp.media({title:"Select your image",button:{text:"Use this Image"},multiple:!1}),r.on("select",function(){var e=r.state().get("selection").first().toJSON(),t=e.mime,n=/^image\/(?:jpe?g|png|gif|svg)$/i,o=t.match(n);o&&(a.val(e.url),a.trigger("change"))}),r.open()}),e(".wpcp-image-selector-default-button").on("click",function(t){var a=e(this).parent().parent().find("input");a.val(e(this).attr("data-default")).trigger("change")}),e(".wpcp-image-selector-input").on("change",function(){e(this).parent().parent().parent().find(".wpcp-image-selector-preview").attr("src",e(this).val())}),window.addEventListener("message",t),e(".wpcp-delete-account-button, .wpcp-refresh-account-button").hide(),e(".wpcp-account").each(function(){var t=e(this),a=t.data("account-id");e.ajax({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-check-account",account_id:a,_ajax_nonce:s.admin_nonce},success:function(e){!1!==e.has_token&&!1!==e.is_authorized||(t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),""!==e.quota_used?(t.find(".wpcp-account-storage-information").text(e.quota_used+"/"+e.quota_total),t.find(".wpcp-account-storage-information-bar").width(e.quota_used_percentage+"%"),0===e.quota_used_percentage&&t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()):(t.find(".wpcp-account-storage-information").parent().fadeOut(),t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()),""!==e.error_message&&(t.find(".wpcp-account-error-message").text(e.error_message),t.find(".wpcp-account-error-details").html(e.error_details),t.find(".wpcp-account-error").fadeIn())},error:function(e){void 0!==e.has_token?(!1!==e.has_token&&!1!==e.is_authorized||(t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),""!==e.quota_used?(t.find(".wpcp-account-storage-information").text(e.quota_used+"/"+e.quota_total),t.find(".wpcp-account-storage-information-bar").width(e.quota_used_percentage+"%")):(t.find(".wpcp-account-storage-information").parent().fadeOut(),t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()),""!==e.error_message&&(t.find(".wpcp-account-error-message").text(e.error_message),t.find(".wpcp-account-error-details").html(e.error_details))):(t.find(".wpcp-account-error-message").text("Could not receive account information. Try to refresh the page or relink your account."),t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),t.find(".wpcp-account-error").fadeIn()},dataType:"json"})}),e("#wpcp-add-account-button, .wpcp-refresh-account-button").on("click",function(t){e(this);window.open(e(this).attr("data-url"),"_blank","toolbar=yes,scrollbars=yes,resizable=yes,width=600,height=900"),e("#wpcp-modal-privacy-policy").fadeIn(),i()}),e(".wpcp-revoke-account-button, .wpcp-delete-account-button").on("click",function(t){var a=e(this).parents(".wpcp-account");a.slideUp(),e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-revoke",account_id:e(this).attr("data-account-id"),force:e(this).attr("data-force"),_ajax_nonce:s.admin_nonce},success:function(t){!0===t.success?(a.remove(),0===e("#wpcp-account-list li").length&&e("#wpcp-account-list").html(""),window.showNotification(!0)):(a.slideDown(),window.showNotification(!1))},error:function(e){a.slideDown(),window.showNotification(!1)},dataType:"json"}),e.ajaxQueue.run()}),e("#wpcp-activate-button").on("click",function(e){window.open(s.activate_url,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,width=1280,height=700")}),e("#license_code").on("change keyup paste",function(t){var a="^([a-z0-9]{8})-?([a-z0-9]{4})-?([a-z0-9]{4})-?([a-z0-9]{4})-?([a-z0-9]{12})$";e(this).val().match(a)?(e(this).css("color","initial"),e(".purchase-input-error").fadeOut(),e("#wpcp-license-activate").removeAttr("disabled")):(e(this).css("color","#dc3232"),e(".purchase-input-error-message").text("Expected format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"),e(".purchase-input-error").fadeIn(),e("#wpcp-license-activate").attr("disabled","disabled"))}),e("#wpcp-license-activate").on("click",function(t){o(e("#license_code").val(),"activate")}),e(".wpcp-license").each(function(){o(e(this).data("license-code"),"get-details")}),e("#wpcp-deactivate-license-button").on("click",function(t){e(this).parents(".wpcp-license").slideUp(),o("","deactivate")}),e("#wpcp-purge-cache-button").on("click",function(t){var a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-reset-cache",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),a.prop("disabled",!1).removeClass("disabled")},dataType:"json"}),i()}),e("#wpcp-export-button").on("click",function(t){var a=e(this);a.prop("disabled",!0).addClass("disabled");var n={action:"shareonedrive-backup",type:"export",_ajax_nonce:s.admin_nonce},o="hiddenDownloader",i=document.getElementById(o);null===i&&(i=document.createElement("iframe"),i.id=o,i.style.display="none",document.body.appendChild(i)),i.src=s.ajax_url+"?"+e.param(n),setTimeout(function(){a.prop("disabled",!1).removeClass("disabled")},5e3)}),e("#wpcp-import-button").on("click",function(t){var a=e(this),n=e(this).parents("form:first"),o=n.find('[type="file"]');if(0!=o[0].files.length){a.prop("disabled",!0).addClass("disabled");var i=new FormData;i.append("tools_import_file",o[0].files[0]),e.ajax({type:"POST",url:s.ajax_url+"?action=shareonedrive-backup&type=import&_ajax_nonce="+s.admin_nonce,data:i,processData:!1,contentType:!1,success:function(e){0!==e.result?(n[0].reset(),window.showNotification(!0),location.reload()):window.showNotification(!1)},error:function(e){window.showNotification(!1)},complete:function(){a.prop("disabled",!1).removeClass("disabled")},dataType:"json"})}else window.showNotification(!1)}),e("#wpcp-factory-reset-button").on("click",function(t){var a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"shareonedrive-factory-reset",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),location.reload()},dataType:"json"}),i()})})(jQuery);